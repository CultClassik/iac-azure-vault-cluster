
## Modules
| Module Name | Description |
|---|---|
| iam | Manages rights for a user managed identity for the Vault AKV. Will create an identity unless var.user_supplied_vm_identity_id is supplied |
| kms | Manages the encryption key in AKV used by the Vault cluster. Will create the key if var.user_supplied_key_vault_key_name is not supplied |
| load_balancer | Manages an application gateway for load balancing the Vault cluster. |
| tls |  |
| user_data |  |
| vm |  |

## Resource Naming
| 1 | 2 | 3 | 4 |
|---|---|---|---|
| resource_name_prefix | unique_id | environment | location |

## TLS Certificates
These are generated by Terraform and stored in Azure Key Vault

## Vault install and config
* Handled by user_data module
  * custom_data, used by cloud-init
  * vmss instance will have a log at /var/log/cloud-init-output.log with output from the custom_data script
  * https://learn.microsoft.com/en-us/azure/virtual-machines/linux/cloud-init-troubleshooting
  * https://learn.microsoft.com/en-us/azure/virtual-machines/linux/cloud-init-deep-dive?source=recommendations
* Uses MSI to allow auto-join and auto-unseal
* Requires one time manual un-seal after provisioning - need a bastion or jump box to access the scale set (`vault operator init`)

## Vault initialization
* Vault must be initialized after intallation, and unsealed. Vault will use Azure key vault to auto unseal in the future
```bash
# vault cli doesn't recoginize the ca cert?
export VAULT_SKIP_VERIFY=true

# copy the unseal keys and root token - one time operation per cluster after provisioning
# these should be stored securely, like in an azure keyvault
azureuser@hcv-Tbngw-vmss-nonprod-eastus000000:~$ vault operator init
Recovery Key 1: G+Zd7a1LTQf+wKZQn+OjqHPjICVBj1TSmc+sCu0jsClP
Recovery Key 2: rgM8h0Pyp4KYsn1pJZnjFRUDWKgHwP0RFpj8mqK/RrGY
Recovery Key 3: UsSm4oCQKf0o4T6ZmaeK1PIA16pig5hvfS1AK39biujZ
Recovery Key 4: 0PukTqpy9JS1mtH2oThcCxeewqQZN1o8+ABI/aXIsVwL
Recovery Key 5: DTjPtuqLZT3ipsaM8QlUKg1sgmK5Ez/3sk7Xs70UTFnD

Initial Root Token: hvs.CL3llw6N4byhEkSomWqG1UsR

Success! Vault is initialized

Recovery key initialized with 5 key shares and a key threshold of 3. Please
securely distribute the key shares printed above.

# exec unseal 3 times, using 3 of the 5 unseal keys from above
# on the 3rd one the "sealed" status should change to false
vault operator unseal


curl --insecure https://localhost:8200
curl --insecure https://vault.dev.verituityplatform.com
```

## Networking
| CIDR | Start IP | End IP | |
|---|---|---|---|
| 172.16.15.0/26	| 172.16.15.1 | 172.16.15.62	| 172.16.15.63 |
| 172.16.15.64/26 |	172.16.15.65 | 172.16.15.126 |	172.16.15.127 |
| 172.16.15.128/26	| 172.16.15.129 | 172.16.15.190	| 172.16.15.191 |
| 172.16.15.192/26 | 172.16.15.193 | 172.16.15.254	| 172.16.15.255 |

## TODO
* Enable "dead server cleanup"
* Use remote state to fetch DNS details like dns parent group rg name, etc
* Use avail zones for agw/lb
* Use avail zones for vm scale set
* AGW should prob be moved to external repo for shared use?
* to limit traffic to vault nodes to be from the load balancer, update api_addr to the IP of the lb in modules/user_data/templates/install_vault.sh.tpl
* add monitoring
* change script in user_data module to a complete cloud-init.conf?
  * download hashicorp vault binary
  * configure vault
  * start and autoenable vault service
  * copy tls certificates from akv https://learn.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-automate-vm-deployment#inject-certificates-from-key-vault

CHANGE APP GW FRONTEND CONFIG FROM PRIVATE TO PUBLIC (LISTENERS)
REMOVE HCV-VAULT-LB NSG RULE "DENYALLINBOUND_INTERNET?
<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3.0 |
| <a name="requirement_acme"></a> [acme](#requirement\_acme) | ~> 2.11.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | ~> 3.31 |
| <a name="requirement_random"></a> [random](#requirement\_random) | ~> 3.4 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | 3.32.0 |
| <a name="provider_local"></a> [local](#provider\_local) | 2.2.3 |
| <a name="provider_random"></a> [random](#provider\_random) | 3.4.3 |
| <a name="provider_tls"></a> [tls](#provider\_tls) | 3.1.50 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_iam"></a> [iam](#module\_iam) | ./modules/iam | n/a |
| <a name="module_keyvault"></a> [keyvault](#module\_keyvault) | ./modules/keyvault | n/a |
| <a name="module_load_balancer"></a> [load\_balancer](#module\_load\_balancer) | ./modules/load_balancer | n/a |
| <a name="module_tls"></a> [tls](#module\_tls) | ./modules/tls | n/a |
| <a name="module_user_data"></a> [user\_data](#module\_user\_data) | ./modules/user_data | n/a |
| <a name="module_vm"></a> [vm](#module\_vm) | ./modules/vm | n/a |
| <a name="module_vnet"></a> [vnet](#module\_vnet) | ./modules/vnet | n/a |

## Resources

| Name | Type |
|------|------|
| [azurerm_dns_a_record.vault](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/dns_a_record) | resource |
| [azurerm_key_vault_secret.bastion_ssh_private_key](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_secret) | resource |
| [azurerm_linux_virtual_machine.bastion](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/linux_virtual_machine) | resource |
| [azurerm_network_interface.bastion_nic](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface) | resource |
| [azurerm_public_ip.bastion_pip](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip) | resource |
| [azurerm_resource_group.vault](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) | resource |
| [local_file.sshkey](https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/file) | resource |
| [local_file.userdata](https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/file) | resource |
| [random_string.unique_id](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string) | resource |
| [tls_private_key.ssh](https://registry.terraform.io/providers/hashicorp/tls/latest/docs/resources/private_key) | resource |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_arm_subscription_id"></a> [arm\_subscription\_id](#input\_arm\_subscription\_id) | n/a | `any` | n/a | yes |
| <a name="input_azure_client_secret"></a> [azure\_client\_secret](#input\_azure\_client\_secret) | For the ACME provider | `any` | n/a | yes |
| <a name="input_dns_zone_name"></a> [dns\_zone\_name](#input\_dns\_zone\_name) | n/a | `any` | n/a | yes |
| <a name="input_dns_zone_rg_name"></a> [dns\_zone\_rg\_name](#input\_dns\_zone\_rg\_name) | n/a | `any` | n/a | yes |
| <a name="input_environment"></a> [environment](#input\_environment) | n/a | `any` | n/a | yes |
| <a name="input_instance_count"></a> [instance\_count](#input\_instance\_count) | n/a | `any` | n/a | yes |
| <a name="input_instance_type"></a> [instance\_type](#input\_instance\_type) | n/a | `any` | n/a | yes |
| <a name="input_lb_autoscale_max_capacity"></a> [lb\_autoscale\_max\_capacity](#input\_lb\_autoscale\_max\_capacity) | n/a | `any` | n/a | yes |
| <a name="input_lb_autoscale_min_capacity"></a> [lb\_autoscale\_min\_capacity](#input\_lb\_autoscale\_min\_capacity) | n/a | `any` | n/a | yes |
| <a name="input_lb_private_ip_address"></a> [lb\_private\_ip\_address](#input\_lb\_private\_ip\_address) | n/a | `any` | n/a | yes |
| <a name="input_location"></a> [location](#input\_location) | n/a | `any` | n/a | yes |
| <a name="input_network"></a> [network](#input\_network) | n/a | `any` | n/a | yes |
| <a name="input_product"></a> [product](#input\_product) | n/a | `any` | n/a | yes |
| <a name="input_vault_version"></a> [vault\_version](#input\_vault\_version) | n/a | `any` | n/a | yes |
| <a name="input_vm_image_id"></a> [vm\_image\_id](#input\_vm\_image\_id) | n/a | `any` | n/a | yes |

## Outputs

No outputs.
<!-- END_TF_DOCS -->