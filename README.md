
## Modules
| Module Name | Description |
|---|---|
| iam | Manages rights for a user managed identity for the Vault AKV. Will create an identity unless var.user_supplied_vm_identity_id is supplied |
| kms | Manages the encryption key in AKV used by the Vault cluster. Will create the key if var.user_supplied_key_vault_key_name is not supplied |
| load_balancer | Manages an application gateway for load balancing the Vault cluster. |
| tls |  |
| user_data |  |
| vm |  |

## Resource Naming
| 1 | 2 | 3 | 4 |
|---|---|---|---|
| resource_name_prefix | unique_id | environment | location |

## TLS Certificates
These are generated by Terraform and stored in Azure Key Vault

## Vault install and config
* Handled by user_data module
  * custom_data, used by cloud-init
  * vmss instance will have a log at /var/log/cloud-init-output.log with output from the custom_data script
  * https://learn.microsoft.com/en-us/azure/virtual-machines/linux/cloud-init-troubleshooting
  * https://learn.microsoft.com/en-us/azure/virtual-machines/linux/cloud-init-deep-dive?source=recommendations
* Uses MSI to allow auto-join and auto-unseal
* Requires one time manual un-seal after provisioning - need a bastion or jump box to access the scale set (`vault operator init`)

## Vault initialization
* Vault must be initialized after intallation, and unsealed. Vault will use Azure key vault to auto unseal in the future
```bash
# vault cli doesn't recoginize the ca cert?
export VAULT_SKIP_VERIFY=true

# copy the unseal keys and root token - one time operation per cluster after provisioning
# these should be stored securely, like in an azure keyvault
azureuser@hcv-Tbngw-vmss-nonprod-eastus000000:~$ vault operator init
Recovery Key 1: G+Zd7a1LTQf+wKZQn+OjqHPjICVBj1TSmc+sCu0jsClP
Recovery Key 2: rgM8h0Pyp4KYsn1pJZnjFRUDWKgHwP0RFpj8mqK/RrGY
Recovery Key 3: UsSm4oCQKf0o4T6ZmaeK1PIA16pig5hvfS1AK39biujZ
Recovery Key 4: 0PukTqpy9JS1mtH2oThcCxeewqQZN1o8+ABI/aXIsVwL
Recovery Key 5: DTjPtuqLZT3ipsaM8QlUKg1sgmK5Ez/3sk7Xs70UTFnD

Initial Root Token: hvs.CL3llw6N4byhEkSomWqG1UsR

Success! Vault is initialized

Recovery key initialized with 5 key shares and a key threshold of 3. Please
securely distribute the key shares printed above.

# exec unseal 3 times, using 3 of the 5 unseal keys from above
# on the 3rd one the "sealed" status should change to false
vault operator unseal


curl --insecure https://localhost:8200
curl --insecure https://vault.dev.verituityplatform.com
```

## Networking
| CIDR | Start IP | End IP | |
|---|---|---|---|
| 172.16.15.0/26	| 172.16.15.1 | 172.16.15.62	| 172.16.15.63 |
| 172.16.15.64/26 |	172.16.15.65 | 172.16.15.126 |	172.16.15.127 |
| 172.16.15.128/26	| 172.16.15.129 | 172.16.15.190	| 172.16.15.191 |
| 172.16.15.192/26 | 172.16.15.193 | 172.16.15.254	| 172.16.15.255 |

## TODO
* Enable "dead server cleanup"
* Use remote state to fetch DNS details like dns parent group rg name, etc
* Use avail zones for agw/lb
* Use avail zones for vm scale set
* AGW should prob be moved to external repo for shared use?
* add dns record(s) for vault
* generate letsencrypt certificate for vault agw
* to limit traffic to vault nodes to be from the load balancer, update api_addr to the IP of the lb in modules/user_data/templates/install_vault.sh.tpl
* change script in user_data module to a complete cloud-init.conf?
  * download hashicorp vault binary
  * configure vault
  * start and autoenable vault service
  * copy tls certificates from akv https://learn.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-automate-vm-deployment#inject-certificates-from-key-vault

CHANGE APP GW FRONTEND CONFIG FROM PRIVATE TO PUBLIC (LISTENERS)
REMOVE HCV-VAULT-LB NSG RULE "DENYALLINBOUND_INTERNET?