# iac-azure-vault-cluster
Manages a HashiCorp Vault cluster in Azure.

## Features
* Creates a cluster with X nodes
* Auto unseal with Azure Key Vault
* Load balanced with an Azure Application Gateway
* Lets Encrypt certificate for the cluster
* Linux VM as a Bastion host
* All initial secrets stored in Azure Key Vault

## Modules
| Module Name | Description |
|---|---|
| nat_gateway | Creates a NAT gateway for the Vault subnet |
| netsec | Creates NSG and rules for Vault subnet |
| userdata | Creates Azure "userdata" for auto config of VMSS instances |
| vm | Creates VM scale set to host the Vault cluster |


## TLS Certificates
These are generated by Terraform and stored in Azure Key Vault by repo iac-azure-vault-components

## Vault install and config
* Handled by user_data module
  * custom_data, used by cloud-init
  * vmss instance will have a log at /var/log/cloud-init-output.log with output from the custom_data script
  * https://learn.microsoft.com/en-us/azure/virtual-machines/linux/cloud-init-troubleshooting
  * https://learn.microsoft.com/en-us/azure/virtual-machines/linux/cloud-init-deep-dive?source=recommendations
* Uses MSI to allow auto-join and auto-unseal
* Requires one time manual un-seal after provisioning - need a bastion or jump box to access the scale set (`vault operator init`)

## Vault initialization
* Vault must be initialized after intallation, and unsealed. Vault will use Azure key vault to auto unseal in the future
```bash
# vault cli doesn't recoginize the ca cert?
export VAULT_SKIP_VERIFY=true

# copy the unseal keys and root token - one time operation per cluster after provisioning
# these should be stored securely, like in an azure keyvault
azureuser@hcv-Tbngw-vmss-nonprod-eastus000000:~$ vault operator init
Recovery Key 1: 5Dq66YoWKqYhU0EnKj4d2OJqHD34Z4gsExqtol83XYnV
Recovery Key 2: /Kgchx1ozP4HzSpqBHggr8tR8kU2clpg/yXLVhurKqhB
Recovery Key 3: ecbDB4ZDeZPy+Yoqz3ZYm/kHDixlm8FVBgoxKdnWOMuZ
Recovery Key 4: MWNaAkFVdPJ6WWUl/UN0m7kqVUXV5thNyg3UIxxG5sFo
Recovery Key 5: 56yNsfDzLaTU1UsA5FzsEZxRvgQ5zghRlR0G5QeSGhiH

Initial Root Token: export VAULT_TOKEN=hvs.o9npdWL24GjRzsxVYlVDEMwn

Success! Vault is initialized

Recovery key initialized with 5 key shares and a key threshold of 3. Please
securely distribute the key shares printed above.

# exec unseal 3 times, using 3 of the 5 unseal keys from above
# on the 3rd one the "sealed" status should change to false
vault operator unseal


curl --insecure https://localhost:8200
curl --insecure https://vault.dev.diehlabsplatform.com
```

## Backup of Vault raft data
* Idea:
    * Use a GRS storage account
    * VMSS instances will have permission to connect via NFS or other means?
    * The VM MSI will have permissions in Vault to read raft data
    * The "init script" for the VMs will configure a cron job that will perform a raft snapshot and copy the data to the storage container

## TODO
* Migrate from gitlab to azure for terraform state
* Enable "dead server cleanup"
* Use remote state to fetch DNS details like dns parent group rg name, etc
* Use avail zones for agw/lb
* Use avail zones for vm scale set
* Use resource_vesionless_id for akv secrets
* to limit traffic to vault nodes to be from the load balancer, update api_addr to the IP of the lb in modules/user_data/templates/install_vault.sh.tpl
* add monitoring
* Backup vault data https://developer.hashicorp.com/vault/tutorials/standard-procedures/sop-backup#automated-backup-procedures
* change script in user_data module to a complete cloud-init.conf?
  * download hashicorp vault binary
  * configure vault
  * start and autoenable vault service
  * copy tls certificates from akv https://learn.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-automate-vm-deployment#inject-certificates-from-key-vault

CHANGE APP GW FRONTEND CONFIG FROM PRIVATE TO PUBLIC (LISTENERS)
REMOVE HCV-VAULT-LB NSG RULE "DENYALLINBOUND_INTERNET?
<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | ~> 3.31 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | 3.32.0 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_nat_gateway"></a> [nat\_gateway](#module\_nat\_gateway) | ./modules/nat_gateway | n/a |
| <a name="module_netsec"></a> [netsec](#module\_netsec) | ./modules/netsec | n/a |
| <a name="module_user_data"></a> [user\_data](#module\_user\_data) | ./modules/user_data | n/a |
| <a name="module_vm"></a> [vm](#module\_vm) | ./modules/vm | n/a |

## Resources

| Name | Type |
|------|------|
| [azurerm_linux_virtual_machine.bastion](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/linux_virtual_machine) | resource |
| [azurerm_network_interface.bastion_nic](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface) | resource |
| [azurerm_network_interface_application_security_group_association.bastion](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface_application_security_group_association) | resource |
| [azurerm_public_ip.bastion_pip](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip) | resource |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) | data source |
| [azurerm_key_vault.vault](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault) | data source |
| [azurerm_key_vault_secret.akv_secret_id_vault_vm_tls](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret) | data source |
| [azurerm_key_vault_secret.bastion_private_key](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret) | data source |
| [azurerm_key_vault_secret.bastion_public_key](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret) | data source |
| [azurerm_key_vault_secret.vault_private_key](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret) | data source |
| [azurerm_key_vault_secret.vault_public_key](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret) | data source |
| [azurerm_resource_group.vault](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/resource_group) | data source |
| [azurerm_subnet.agw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subnet) | data source |
| [azurerm_subnet.bastion](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subnet) | data source |
| [azurerm_subnet.vault](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subnet) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_agw_backend_address_pool_id"></a> [agw\_backend\_address\_pool\_id](#input\_agw\_backend\_address\_pool\_id) | The ID of the backend address pool form the AGW to assign the vm scale set instances to | `string` | n/a | yes |
| <a name="input_az_sub_id"></a> [az\_sub\_id](#input\_az\_sub\_id) | n/a | `any` | n/a | yes |
| <a name="input_dns_zone_name"></a> [dns\_zone\_name](#input\_dns\_zone\_name) | n/a | `any` | n/a | yes |
| <a name="input_environment"></a> [environment](#input\_environment) | n/a | `any` | n/a | yes |
| <a name="input_instance_count"></a> [instance\_count](#input\_instance\_count) | n/a | `any` | n/a | yes |
| <a name="input_instance_type"></a> [instance\_type](#input\_instance\_type) | n/a | `any` | n/a | yes |
| <a name="input_key_vault_name"></a> [key\_vault\_name](#input\_key\_vault\_name) | Name of the Keyvault to use. Could be sourced from remote state. | `string` | n/a | yes |
| <a name="input_location"></a> [location](#input\_location) | n/a | `any` | n/a | yes |
| <a name="input_subnet_name_bastion"></a> [subnet\_name\_bastion](#input\_subnet\_name\_bastion) | n/a | `any` | n/a | yes |
| <a name="input_subnet_name_vault"></a> [subnet\_name\_vault](#input\_subnet\_name\_vault) | n/a | `any` | n/a | yes |
| <a name="input_subnet_name_vault_agw"></a> [subnet\_name\_vault\_agw](#input\_subnet\_name\_vault\_agw) | n/a | `any` | n/a | yes |
| <a name="input_vault_identity_client_id"></a> [vault\_identity\_client\_id](#input\_vault\_identity\_client\_id) | The Client ID of the MSI used by the Vault cluster nodes. Could be sourced from remote state. | `string` | n/a | yes |
| <a name="input_vault_identity_id"></a> [vault\_identity\_id](#input\_vault\_identity\_id) | The resource ID of the MSI used by the Vault cluster nodes. Could be sourced from remote state. | `string` | n/a | yes |
| <a name="input_vault_version"></a> [vault\_version](#input\_vault\_version) | n/a | `any` | n/a | yes |
| <a name="input_vm_image_id"></a> [vm\_image\_id](#input\_vm\_image\_id) | n/a | `any` | n/a | yes |
| <a name="input_vnet_name"></a> [vnet\_name](#input\_vnet\_name) | n/a | `any` | n/a | yes |
| <a name="input_vnet_rg_name"></a> [vnet\_rg\_name](#input\_vnet\_rg\_name) | n/a | `any` | n/a | yes |

## Outputs

No outputs.
<!-- END_TF_DOCS -->