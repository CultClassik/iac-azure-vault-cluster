
## Modules
| Module Name | Description |
|---|---|
| iam | Manages rights for a user managed identity for the Vault AKV. Will create an identity unless var.user_supplied_vm_identity_id is supplied |
| kms | Manages the encryption key in AKV used by the Vault cluster. Will create the key if var.user_supplied_key_vault_key_name is not supplied |
| load_balancer | Manages an application gateway for load balancing the Vault cluster. |
| tls |  |
| user_data |  |
| vm |  |

## Resource Naming
| 1 | 2 | 3 | 4 |
|---|---|---|---|
| resource_name_prefix | unique_id | environment | location |

## TLS Certificates
These are generated by Terraform and stored in Azure Key Vault

## Vault install and config
* Handled by user_data module
* Uses MSI to allow auto-join and auto-unseal
* Requires one time manual un-seal after provisioning - need a bastion or jump box to access the scale set

## TODO
* Use remote state to fetch DNS details like dns parent group rg name, etc
* Use avail zones for agw/lb
* Use avail zones for vm scale set
* AGW should prob be moved to external repo for shared use?
* add dns record(s) for vault
* generate letsencrypt certificate for vault agw
* to limit traffic to vault nodes to be from the load balancer, update api_addr to the IP of the lb in modules/user_data/templates/install_vault.sh.tpl
* change script in user_data module to a complete cloud-init.conf?
  * download hashicorp vault binary
  * configure vault
  * start and autoenable vault service
  * copy tls certificates from akv https://learn.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-automate-vm-deployment#inject-certificates-from-key-vault